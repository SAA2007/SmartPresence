<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SmartPresence{% endblock %}</title>
    <meta name="description" content="AI-Powered Attendance System">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token is defined else '' }}">
</head>

<body>
    <div class="app-layout">
        <nav class="sidebar">
            <div class="sidebar-brand">
                <i class="bi bi-person-bounding-box"></i>
                <span>SmartPresence</span>
            </div>
            <ul class="sidebar-nav">
                <li><a href="/" class="{% if request.path == '/' %}active{% endif %}">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a></li>
                <li><a href="/live" class="{% if request.path == '/live' %}active{% endif %}">
                        <i class="bi bi-camera-video"></i> Live View
                    </a></li>
                <li><a href="/students"
                        class="{% if request.path == '/students' or request.path.startswith('/student/') %}active{% endif %}">
                        <i class="bi bi-people"></i> Students
                    </a></li>
                <li><a href="/enroll" class="{% if request.path == '/enroll' %}active{% endif %}">
                        <i class="bi bi-person-plus"></i> Enrollment
                    </a></li>
                <li><a href="/settings" class="{% if request.path == '/settings' %}active{% endif %}">
                        <i class="bi bi-gear"></i> Settings
                    </a></li>
                {% if session.get('role') == 'admin' %}
                <li><a href="/users" class="{% if request.path == '/users' %}active{% endif %}">
                        <i class="bi bi-shield-lock"></i> Users
                    </a></li>
                {% endif %}
                <li class="nav-divider"></li>
                <li><a href="/report" class="{% if request.path == '/report' %}active{% endif %}">
                        <i class="bi bi-bug"></i> Report Issue
                    </a></li>
            </ul>
            <div class="sidebar-footer">
                <div id="systemIndicator" class="system-indicator">
                    <span class="indicator-dot"></span>
                    <small>Loading...</small>
                </div>
                <div class="sidebar-user">
                    <div class="d-flex align-items-center justify-content-between">
                        <small class="text-muted text-truncate" style="max-width:120px;"
                            title="{{ session.get('display_name', '') }}">
                            <i class="bi bi-person-circle"></i> {{ session.get('display_name', 'User') }}
                            {% if session.get('role') == 'admin' %}<span class="badge bg-danger ms-1"
                                style="font-size:0.6rem;">ADMIN</span>{% endif %}
                        </small>
                        <a href="/logout" class="btn btn-link btn-sm text-muted p-0" title="Logout">
                            <i class="bi bi-box-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Toast container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1050;">
        <div id="toastContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        // Global XSS protection — use on ALL user-supplied data before innerHTML
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        // Global toast function (message is escaped to prevent XSS)
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            // Limit to 3 toasts
            while (container.children.length >= 3) container.removeChild(container.firstChild);
            const colors = { success: '#27ae60', error: '#e74c3c', warning: '#f39c12', info: 'var(--accent)' };
            const toast = document.createElement('div');
            toast.className = 'toast show mb-2';
            toast.style.cssText = `background:var(--bg-secondary);border:1px solid var(--border-color);min-width:250px;`;
            toast.innerHTML = `<div class="toast-body d-flex align-items-center gap-2">
                <span style="color:${colors[type] || colors.info};">●</span> ${escapeHtml(message)}
                <button type="button" class="btn-close btn-close-white btn-sm ms-auto" onclick="this.closest('.toast').remove()"></button>
            </div>`;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 4000);
        }

        // Global safeFetch with CSRF token
        async function safeFetch(url, options = {}) {
            try {
                // Auto-inject CSRF token for state-changing methods
                const method = (options.method || 'GET').toUpperCase();
                if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    if (csrfMeta && csrfMeta.content) {
                        options.headers = {
                            ...(options.headers || {}),
                            'X-CSRFToken': csrfMeta.content
                        };
                    }
                }
                const r = await fetch(url, options);
                if (r.status === 401) { window.location.href = '/login'; return null; }
                if (!r.ok) {
                    const data = await r.json().catch(() => ({}));
                    showToast(data.error || `Request failed (${r.status})`, 'error');
                    return null;
                }
                return r;
            } catch (e) {
                showToast('Network error. Check your connection.', 'error');
                return null;
            }
        }

        // System status indicator
        function updateSystemIndicator() {
            safeFetch('/api/system/status').then(r => {
                if (!r) return;
                return r.json();
            }).then(data => {
                if (!data) return;
                const el = document.getElementById('systemIndicator');
                if (!el) return;
                const running = data.ai_running;
                const mode = data.system_mode;
                const modeLabel = { auto: 'Auto', force_on: 'ON', force_off: 'OFF' }[mode] || mode;
                const schedName = data.active_schedule ? data.active_schedule.class_name : 'No Class';

                let dotClass = running ? 'dot-active' : 'dot-off';
                if (running && mode === 'force_off') dotClass = 'dot-off';
                if (running && !data.active_schedule && mode === 'auto') dotClass = 'dot-idle';

                el.innerHTML = `<span class="indicator-dot ${dotClass}"></span>
                <small>${running ? 'AI On' : 'AI Off'} · ${modeLabel} · ${schedName}</small>`;
            }).catch(() => { });
        }
        updateSystemIndicator();
        setInterval(updateSystemIndicator, 5000);
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>