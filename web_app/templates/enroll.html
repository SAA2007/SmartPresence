{% extends "base.html" %}
{% block title %}Enrollment - SmartPresence{% endblock %}
{% block content %}
<div class="page-header">
    <h1><i class="bi bi-person-plus"></i> Web Enrollment</h1>
</div>

<div class="row g-4">
    <!-- Camera Capture -->
    <div class="col-md-7">
        <div class="card glass-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-camera"></i> Capture Photo</h5>
            </div>
            <div class="card-body text-center">
                <div class="enroll-video-container mb-3">
                    <video id="enrollVideo" autoplay playsinline class="enroll-video"></video>
                    <canvas id="enrollCanvas" style="display:none;"></canvas>
                    <img id="capturedPhoto" class="enroll-video" style="display:none;">
                </div>
                <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-accent" id="captureBtn" onclick="capturePhoto()">
                        <i class="bi bi-camera"></i> Capture
                    </button>
                    <button class="btn btn-outline-light" id="retakeBtn" onclick="retakePhoto()" style="display:none;">
                        <i class="bi bi-arrow-counterclockwise"></i> Retake
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Or upload a photo:</small>
                    <input type="file" accept="image/*" id="photoUpload" class="form-control form-control-sm mt-1"
                        style="max-width:300px;margin:0 auto;" onchange="handleUpload(this)">
                </div>
            </div>
        </div>
    </div>

    <!-- Enrollment Form -->
    <div class="col-md-5">
        <div class="card glass-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Student Details</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Full Name <span class="text-danger">*</span></label>
                    <input type="text" id="enrollName" class="form-control" placeholder="First and Last Name">
                </div>
                <div class="mb-3">
                    <label class="form-label">Student ID <span class="text-danger">*</span></label>
                    <input type="text" id="enrollSid" class="form-control" placeholder="e.g. 2024-CS-101" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" id="enrollEmail" class="form-control" placeholder="student@university.edu"
                        required>
                </div>
                <div id="enrollStatus" class="mb-3" style="display:none;"></div>
                <button class="btn btn-accent w-100" id="enrollBtn" onclick="enrollStudent()" disabled>
                    <i class="bi bi-person-check"></i> Enroll Student
                </button>
            </div>
        </div>

        <div class="card glass-card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Tips</h6>
            </div>
            <div class="card-body small text-muted">
                <ul class="mb-0 ps-3">
                    <li>Face the camera directly with good lighting</li>
                    <li>Only one person should be in the frame</li>
                    <li>Remove hats or sunglasses</li>
                    <li>You can also upload any clear photo</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let imageData = null;
    let videoStream = null;

    // Start webcam
    async function startCamera() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: { width: 1280, height: 720, facingMode: 'user' }
            });
            document.getElementById('enrollVideo').srcObject = videoStream;
        } catch (e) {
            console.warn('Camera not available:', e);
            const video = document.getElementById('enrollVideo');
            video.style.display = 'none';
            const container = video.parentElement;
            container.insertAdjacentHTML('afterbegin',
                `<div class="alert alert-warning py-2 mb-2 small text-center">
                    <i class="bi bi-camera-video-off"></i> Camera unavailable.
                    Use the <strong>upload option</strong> below to add a photo.
                </div>`);
            document.getElementById('captureBtn').disabled = true;
            showToast('Camera access denied or unavailable', 'warning');
        }
    }

    function capturePhoto() {
        const video = document.getElementById('enrollVideo');
        const canvas = document.getElementById('enrollCanvas');
        const photo = document.getElementById('capturedPhoto');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        imageData = canvas.toDataURL('image/jpeg', 0.9);
        photo.src = imageData;

        video.style.display = 'none';
        photo.style.display = 'block';
        document.getElementById('captureBtn').style.display = 'none';
        document.getElementById('retakeBtn').style.display = 'inline-block';
        document.getElementById('enrollBtn').disabled = false;
    }

    function retakePhoto() {
        const video = document.getElementById('enrollVideo');
        const photo = document.getElementById('capturedPhoto');

        video.style.display = 'block';
        photo.style.display = 'none';
        document.getElementById('captureBtn').style.display = 'inline-block';
        document.getElementById('retakeBtn').style.display = 'none';
        document.getElementById('enrollBtn').disabled = true;
        imageData = null;
    }

    function handleUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // Client-side size limit: 5MB
        const MAX_SIZE = 5 * 1024 * 1024;
        if (file.size > MAX_SIZE) {
            showToast(`Image too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Max 5MB.`, 'error');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            imageData = e.target.result;
            const photo = document.getElementById('capturedPhoto');
            const video = document.getElementById('enrollVideo');

            photo.src = imageData;
            video.style.display = 'none';
            photo.style.display = 'block';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('enrollBtn').disabled = false;
        };
        reader.readAsDataURL(file);
    }

    function enrollStudent(force = false) {
        const name = document.getElementById('enrollName').value.trim();
        const studentId = document.getElementById('enrollSid').value.trim();
        const email = document.getElementById('enrollEmail').value.trim();
        if (!name) { showToast('Name is required'); return; }
        if (!studentId) { showToast('Student ID is required'); return; }
        if (!email) { showToast('Email is required'); return; }
        if (!imageData) { showToast('Capture or upload a photo first'); return; }

        const btn = document.getElementById('enrollBtn');
        const status = document.getElementById('enrollStatus');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
        status.style.display = 'none';

        safeFetch('/api/enroll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                student_id: studentId,
                email: email,
                image: imageData,
                force: force
            })
        })
            .then(r => {
                if (!r) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-person-check"></i> Enroll Student'; return; }
                return r.json();
            })
            .then(data => {
                if (!data) return;
                if (data.success) {
                    status.style.display = 'block';
                    status.className = 'mb-3 alert alert-success py-2 small';
                    status.innerHTML = `<i class="bi bi-check-circle"></i> <strong>${escapeHtml(name)}</strong> enrolled successfully! The AI will recognize them immediately.`;
                    showToast(`${name} enrolled!`, 'success');

                    // Reset form
                    document.getElementById('enrollName').value = '';
                    document.getElementById('enrollSid').value = '';
                    document.getElementById('enrollEmail').value = '';
                    retakePhoto();
                } else if (data.duplicate) {
                    // Duplicate face detected — show override option
                    status.style.display = 'block';
                    status.className = 'mb-3 alert alert-warning py-2 small';
                    status.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${escapeHtml(data.error)}
                        <br><button class="btn btn-sm btn-outline-warning mt-2" onclick="enrollStudent(true)">
                        <i class="bi bi-shield-exclamation"></i> Override — enroll anyway</button>`;
                    btn.disabled = false;
                } else {
                    status.style.display = 'block';
                    status.className = 'mb-3 alert alert-danger py-2 small';
                    status.innerHTML = `<i class="bi bi-exclamation-circle"></i> ${escapeHtml(data.error)}`;
                    btn.disabled = false;
                }
                btn.innerHTML = '<i class="bi bi-person-check"></i> Enroll Student';
            })
            .catch(err => {
                status.style.display = 'block';
                status.className = 'mb-3 alert alert-danger py-2 small';
                status.innerHTML = `<i class="bi bi-exclamation-circle"></i> Network error: ${escapeHtml(err.message)}`;
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-person-check"></i> Enroll Student';
            });
    }

    startCamera();
</script>
{% endblock %}