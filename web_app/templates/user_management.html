{% extends "base.html" %}
{% block title %}User Management - SmartPresence{% endblock %}
{% block content %}
<div class="page-header">
    <h1><i class="bi bi-people-fill"></i> User Management</h1>
    <div class="header-actions">
        <button class="btn btn-sm btn-accent" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-person-plus"></i> Add User
        </button>
    </div>
</div>

<div class="card glass-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Username</th>
                        <th>Display Name</th>
                        <th>Role</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content" style="background:var(--bg-secondary);border:1px solid var(--border-color);">
            <div class="modal-header border-0">
                <h6 class="modal-title"><i class="bi bi-person-plus"></i> Add User</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label small">Username <span class="text-danger">*</span></label>
                    <input type="text" id="addUsername" class="form-control form-control-sm"
                        placeholder="e.g. teacher1">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Display Name</label>
                    <input type="text" id="addDisplayName" class="form-control form-control-sm"
                        placeholder="e.g. Dr. Ahmed">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Password <span class="text-danger">*</span></label>
                    <input type="password" id="addPassword" class="form-control form-control-sm"
                        placeholder="Min 4 characters">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Role</label>
                    <select id="addRole" class="form-select form-select-sm">
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-accent btn-sm" onclick="addUser()">
                    <i class="bi bi-plus-circle"></i> Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content" style="background:var(--bg-secondary);border:1px solid var(--border-color);">
            <div class="modal-header border-0">
                <h6 class="modal-title"><i class="bi bi-pencil"></i> Edit User</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="mb-2">
                    <label class="form-label small">Display Name</label>
                    <input type="text" id="editDisplayName" class="form-control form-control-sm">
                </div>
                <div class="mb-2">
                    <label class="form-label small">New Password <span class="text-muted">(leave blank to
                            keep)</span></label>
                    <input type="password" id="editPassword" class="form-control form-control-sm"
                        placeholder="Optional">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Role</label>
                    <select id="editRole" class="form-select form-select-sm">
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-accent btn-sm" onclick="saveUser()">
                    <i class="bi bi-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allUsers = [];

    function loadUsers() {
        safeFetch('/api/users').then(r => {
            if (!r) return;
            return r.json();
        }).then(data => {
            if (!data) return;
            allUsers = data;
            const tbody = document.getElementById('usersTable');
            if (!data.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No users</td></tr>'; return; }
            tbody.innerHTML = data.map((u, i) => {
                const roleBadge = u.role === 'admin' ? '<span class="badge bg-danger">Admin</span>' : '<span class="badge bg-info">Teacher</span>';
                const created = new Date(u.created_at).toLocaleDateString('en-GB');
                return `<tr>
                <td>${i + 1}</td>
                <td><strong>${escapeHtml(u.username)}</strong></td>
                <td>${escapeHtml(u.display_name)}</td>
                <td>${roleBadge}</td>
                <td class="text-muted small">${created}</td>
                <td>
                    <button class="btn btn-outline-light btn-xs" onclick="editUser(${u.id})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-danger btn-xs" onclick="deleteUser(${u.id}, '${escapeHtml(u.username).replace(/'/g, "\\'")}')"><i class="bi bi-trash"></i></button>
                </td>
            </tr>`;
            }).join('');
        }).catch(() => showToast('Failed to load users', 'error'));
    }

    function addUser() {
        const username = document.getElementById('addUsername').value.trim();
        const password = document.getElementById('addPassword').value;
        if (!username || !password) { showToast('Username and password are required'); return; }
        if (password.length < 6) { showToast('Password must be at least 6 characters'); return; }

        safeFetch('/api/users', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username, password,
                display_name: document.getElementById('addDisplayName').value.trim(),
                role: document.getElementById('addRole').value
            })
        }).then(r => {
            if (!r) return;
            return r.json();
        }).then(data => {
            if (!data) return;
            if (data.success) {
                showToast('User created!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                loadUsers();
            } else { showToast(data.error || 'Failed', 'error'); }
        });
    }

    function editUser(id) {
        const u = allUsers.find(x => x.id === id);
        if (!u) return;
        document.getElementById('editUserId').value = u.id;
        document.getElementById('editDisplayName').value = u.display_name;
        document.getElementById('editRole').value = u.role;
        document.getElementById('editPassword').value = '';
        new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    function saveUser() {
        const id = document.getElementById('editUserId').value;
        const body = {
            display_name: document.getElementById('editDisplayName').value.trim(),
            role: document.getElementById('editRole').value
        };
        const pw = document.getElementById('editPassword').value;
        if (pw) body.password = pw;

        safeFetch(`/api/users/${id}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }).then(r => {
            if (!r) return;
            return r.json();
        }).then(data => {
            if (!data) return;
            if (data.success) {
                showToast('User updated!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            } else { showToast(data.error || 'Failed', 'error'); }
        });
    }

    function deleteUser(id, name) {
        if (!confirm(`Delete user "${name}"? This cannot be undone.`)) return;
        safeFetch(`/api/users/${id}`, { method: 'DELETE' }).then(r => {
            if (!r) return;
            return r.json();
        }).then(data => {
            if (!data) return;
            if (data.success) { showToast('User deleted', 'success'); loadUsers(); }
            else { showToast(data.error || 'Failed', 'error'); }
        });
    }

    loadUsers();
</script>
{% endblock %}