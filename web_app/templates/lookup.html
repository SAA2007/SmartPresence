<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Lookup - SmartPresence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .lookup-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            padding: 1rem;
        }

        .lookup-card {
            width: 100%;
            max-width: 520px;
            padding: 2.5rem;
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }

        .lookup-brand {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .lookup-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .stat-mini {
            text-align: center;
            padding: 0.8rem 0.5rem;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 10px;
        }

        .stat-mini .value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .stat-mini .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .lookup-error {
            display: none;
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <div class="lookup-wrapper">
        <div class="lookup-card">
            <div class="lookup-brand">
                <i class="bi bi-search"></i> Attendance Lookup
            </div>
            <p class="lookup-subtitle">Enter your Student ID to view your attendance</p>

            <div class="lookup-error" id="lookupError"></div>

            <form onsubmit="doLookup(event)">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                        <input type="text" id="studentIdInput" class="form-control" placeholder="e.g. STU001" autofocus
                            required>
                    </div>
                </div>
                <button type="submit" class="btn btn-accent w-100" id="lookupBtn">
                    <i class="bi bi-search"></i> Look Up
                </button>
            </form>

            <!-- Results Section -->
            <div class="result-section mt-4" id="resultSection">
                <hr>
                <h5 class="mb-1" id="resName">—</h5>
                <p class="text-muted small mb-3" id="resSid">—</p>

                <div class="row g-2 mb-3">
                    <div class="col-3">
                        <div class="stat-mini">
                            <div class="value text-success" id="resPresent">-</div>
                            <div class="label">Present</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-mini">
                            <div class="value text-warning" id="resLate">-</div>
                            <div class="label">Late</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-mini">
                            <div class="value text-danger" id="resAbsent">-</div>
                            <div class="label">Absent</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-mini">
                            <div class="value text-info" id="resRate">-</div>
                            <div class="label">Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Progress bar -->
                <div class="progress mb-3" style="height:6px;background:rgba(255,255,255,0.06);border-radius:4px;">
                    <div class="progress-bar" id="rateBar"
                        style="width:0%;border-radius:4px;transition:width 0.5s ease;"></div>
                </div>

                <!-- Recent records -->
                <h6 class="text-muted small mb-2"><i class="bi bi-clock-history"></i> Recent Records</h6>
                <div style="max-height:250px;overflow-y:auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody id="recentTable"></tbody>
                    </table>
                </div>
            </div>

            <a href="/login" class="back-link text-muted">
                <i class="bi bi-box-arrow-in-right"></i> Staff Login
            </a>
        </div>
    </div>

    <script>
        function escapeHtml(s) {
            const d = document.createElement('div');
            d.textContent = s || '';
            return d.innerHTML;
        }

        const statusColors = {
            'Present': 'bg-success', 'On Time': 'bg-success', 'Late': 'bg-warning text-dark',
            'Absent': 'bg-danger', 'Disappeared': 'bg-secondary', 'Early Leave': 'bg-info',
            'Permitted': 'bg-primary', 'Excused': 'bg-secondary'
        };

        async function doLookup(e) {
            e.preventDefault();
            const btn = document.getElementById('lookupBtn');
            const err = document.getElementById('lookupError');
            const sid = document.getElementById('studentIdInput').value.trim();

            if (!sid) { err.textContent = 'Please enter a Student ID.'; err.style.display = 'block'; return; }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Looking up...';
            err.style.display = 'none';
            document.getElementById('resultSection').classList.remove('show');

            try {
                const r = await fetch('/api/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: sid })
                });

                const data = await r.json().catch(() => ({}));

                if (!r.ok) {
                    throw new Error(data.error || `Lookup failed (${r.status})`);
                }

                // Populate results
                document.getElementById('resName').textContent = data.name;
                document.getElementById('resSid').textContent = 'ID: ' + data.student_id;
                document.getElementById('resPresent').textContent = data.stats.present;
                document.getElementById('resLate').textContent = data.stats.late;
                document.getElementById('resAbsent').textContent = data.stats.absent;
                document.getElementById('resRate').textContent = data.stats.attendance_rate + '%';

                const bar = document.getElementById('rateBar');
                bar.style.width = data.stats.attendance_rate + '%';
                bar.style.background = data.stats.attendance_rate >= 80 ? '#2ecc71' :
                    data.stats.attendance_rate >= 50 ? '#f39c12' : '#e74c3c';

                // Render recent
                const tbody = document.getElementById('recentTable');
                if (!data.recent_attendance.length) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No records</td></tr>';
                } else {
                    tbody.innerHTML = data.recent_attendance.map(r => {
                        const dt = new Date(r.timestamp);
                        const dateStr = dt.toLocaleDateString('en-GB') + ' ' + dt.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        const color = statusColors[r.status] || 'bg-secondary';
                        const srcIcon = r.source === 'ai' ? '<i class="bi bi-robot text-info"></i>' :
                            r.source === 'manual' ? '<i class="bi bi-pencil text-warning"></i>' :
                                '<i class="bi bi-arrow-repeat text-danger"></i>';
                        return `<tr>
                            <td class="text-muted small">${dateStr}</td>
                            <td><span class="badge ${color}">${escapeHtml(r.status)}</span></td>
                            <td>${srcIcon}</td>
                        </tr>`;
                    }).join('');
                }

                document.getElementById('resultSection').classList.add('show');
            } catch (e) {
                err.textContent = e.message || 'Network error. Is the server running?';
                err.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-search"></i> Look Up';
            }
        }
    </script>
</body>

</html>